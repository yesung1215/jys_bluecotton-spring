<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.app.bluecotton.mapper.PostMapper">

    <!-- 오늘의 솜 메인페이지 게시글 리스트 조회 (+ 좋아요 여부 포함) -->
    <select id="select" resultType="PostMainDTO">
        SELECT
        TBP.ID,
        TBS.SOM_CATEGORY,
        TBS.SOM_TITLE,
        TRUNC(TRUNC(TBP.POST_CREATE_AT) - TRUNC(TBS.SOM_START_DATE)) + 1 AS POST_SOM_DAY,
        TBP.POST_TITLE,
        TBP.POST_CONTENT,
        TBM.MEMBER_NICKNAME,
        NVL(
        TBMP.MEMBER_PROFILE_PATH || TBMP.MEMBER_PROFILE_NAME,
        'https://image-server.ideaflow.co.kr/uploads/default/default_profile.png'
        ) AS MEMBER_PROFILE_URL,
        TBP.POST_CREATE_AT,
        TBP.POST_READ_COUNT,

        -- 썸네일 이미지 1개
        NVL(TPI.POST_IMAGE_PATH || TPI.POST_IMAGE_NAME, '/upload/default/default_post.jpg') AS POST_IMAGE_URL,

        -- 좋아요 총 개수
        (SELECT COUNT(*) FROM TBL_POST_LIKE L WHERE L.POST_ID = TBP.ID) AS POST_LIKE_COUNT,

        -- 댓글 + 대댓글 총 개수
        (
        SELECT COUNT(*) FROM TBL_POST_COMMENT TPC WHERE TPC.POST_ID = TBP.ID
        )
        +
        (
        SELECT COUNT(*) FROM TBL_POST_REPLY TPR
        WHERE TPR.POST_COMMENT_ID IN (SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = TBP.ID)
        ) AS POST_COMMENT_COUNT,

        -- 로그인 유저의 좋아요 여부
        CASE
        WHEN #{memberId} IS NULL THEN 0
        WHEN EXISTS (
        SELECT 1 FROM TBL_POST_LIKE TPL
        WHERE TPL.POST_ID = TBP.ID AND TPL.MEMBER_ID = #{memberId}
        ) THEN 1
        ELSE 0
        END AS POST_IS_LIKE

        FROM TBL_POST TBP
        JOIN TBL_MEMBER TBM ON TBP.MEMBER_ID = TBM.ID
        LEFT JOIN TBL_SOM TBS ON TBP.SOM_ID = TBS.ID
        LEFT JOIN TBL_MEMBER_PROFILE TBMP ON TBM.ID = TBMP.MEMBER_ID

        -- 대표 이미지 1개 가져오기 : Oracle 정석
        LEFT JOIN (
        SELECT POST_ID, POST_IMAGE_PATH, POST_IMAGE_NAME
        FROM (
        SELECT
        POST_ID,
        POST_IMAGE_PATH,
        POST_IMAGE_NAME,
        ROW_NUMBER() OVER (PARTITION BY POST_ID ORDER BY ID ASC) AS RN
        FROM TBL_POST_IMAGE
        )
        WHERE RN = 1
        ) TPI ON TPI.POST_ID = TBP.ID

        WHERE 1 = 1

        <!-- 카테고리 필터 -->
        <if test="somCategory != null and somCategory != ''">
            AND UPPER(TBS.SOM_CATEGORY) = UPPER(#{somCategory})
        </if>

        <!-- 검색 필터 -->
        <if test="q != null and q != ''">
            AND (
            TBP.POST_TITLE LIKE '%' || #{q} || '%'
            OR TBP.POST_CONTENT LIKE '%' || #{q} || '%'
            OR TBM.MEMBER_NICKNAME LIKE '%' || #{q} || '%'
            )
        </if>

        <!-- 정렬 -->
        <choose>
            <when test="orderType == 'view'">
                ORDER BY TBP.POST_READ_COUNT DESC, TBP.ID DESC
            </when>
            <when test="orderType == 'popular'">
                ORDER BY POST_LIKE_COUNT DESC, TBP.ID DESC
            </when>
            <when test="orderType == 'comment'">
                ORDER BY POST_COMMENT_COUNT DESC, TBP.ID DESC
            </when>
            <otherwise>
                ORDER BY TBP.POST_CREATE_AT DESC, TBP.ID DESC
            </otherwise>
        </choose>

        <!-- 페이징 -->
        OFFSET #{page} * #{size} ROWS
        FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 전체 게시글 개수 조회 -->
    <select id="countPosts" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST TBP
        JOIN TBL_MEMBER TBM ON TBP.MEMBER_ID = TBM.ID
        LEFT JOIN TBL_SOM TBS ON TBP.SOM_ID = TBS.ID
        WHERE 1 = 1

        <if test="somCategory != null and somCategory != ''">
            AND UPPER(TBS.SOM_CATEGORY) = UPPER(#{somCategory})
        </if>

        <if test="q != null and q != ''">
            AND (
            TBP.POST_TITLE LIKE '%' || #{q} || '%'
            OR TBP.POST_CONTENT LIKE '%' || #{q} || '%'
            OR TBM.MEMBER_NICKNAME LIKE '%' || #{q} || '%'
            )
        </if>
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="PostVO">
        <selectKey keyProperty="id" order="BEFORE" resultType="Long">
            SELECT SEQ_POST.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO TBL_POST (
        ID, POST_TITLE, POST_CONTENT,
        POST_CREATE_AT, POST_READ_COUNT, POST_STATUS,
        MEMBER_ID, SOM_ID
        ) VALUES (
        #{id}, #{postTitle}, #{postContent},
        SYSTIMESTAMP, 0, 'Y',
        #{memberId}, #{somId}
        )
    </insert>

    <!-- 특정 회원이 오늘 특정 솜에 게시했는지 확인 -->
    <select id="existsTodayPostInSom" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST
        WHERE MEMBER_ID = #{memberId}
        AND SOM_ID = #{somId}
        AND POST_STATUS = 'Y'
        AND TRUNC(POST_CREATE_AT) = TRUNC(SYSDATE)
    </select>

    <!-- 업로드된 이미지 → 게시글 ID 매핑 -->
    <update id="updatePostIdByUrl">
        UPDATE TBL_POST_IMAGE
        SET POST_ID = #{postId}
        WHERE POST_IMAGE_PATH || POST_IMAGE_NAME = #{url}
    </update>

    <!-- 기본 이미지 등록 -->
    <insert id="insertDefaultImage">
        INSERT INTO TBL_POST_IMAGE (ID, POST_IMAGE_PATH, POST_IMAGE_NAME, POST_ID)
        VALUES (SEQ_POST_IMAGE.NEXTVAL, #{postImagePath}, #{postImageName}, #{postId})
    </insert>

    <!-- 첫 번째 이미지를 대표 썸네일로 등록 -->
    <insert id="insertThumbnail">
        INSERT INTO TBL_POST_IMAGE (ID, POST_IMAGE_PATH, POST_IMAGE_NAME, POST_ID)
        VALUES (SEQ_POST_IMAGE.NEXTVAL, #{postImagePath}, #{postImageName}, #{postId})
    </insert>

    <!-- [게시글 등록용] 참여 중인 솜 -->
    <select id="findJoinedSomsByMemberId" parameterType="Long" resultType="SomCategoryDTO">
        SELECT TBS.ID, TBS.SOM_CATEGORY, TBS.SOM_TITLE,
            TRUNC(TRUNC(SYSDATE) - TRUNC(TBS.SOM_START_DATE)) + 1 AS SOM_DAY_DIFF
        FROM TBL_SOM TBS
        JOIN TBL_SOM_JOIN TBSJ ON TBS.ID = TBSJ.SOM_ID
        WHERE TBSJ.MEMBER_ID = #{memberId}
        AND TRUNC(TBS.SOM_END_DATE) >= TRUNC(SYSDATE)
    </select>

    <!-- 게시글 수정용 조회 -->
    <select id="findByIdForUpdate" parameterType="Long" resultType="PostModifyDTO">
        SELECT TBP.ID, TBP.POST_TITLE, TBP.POST_CONTENT, TBP.MEMBER_ID, TBP.SOM_ID, TBS.SOM_CATEGORY
        FROM TBL_POST TBP
        JOIN TBL_SOM TBS ON TBP.SOM_ID = TBS.ID
        WHERE TBP.ID = #{id}
    </select>

    <!-- [게시글 수정] 참여 중인 솜 목록 -->
    <select id="findJoinedCategories" parameterType="Long" resultType="SomCategoryDTO">
        SELECT TBS.ID, TBS.SOM_CATEGORY
        FROM TBL_SOM TBS
        JOIN TBL_SOM_JOIN TBSJ ON TBS.ID = TBSJ.SOM_ID
        WHERE TBSJ.MEMBER_ID = #{memberId}
    </select>

    <!-- 게시글 수정 -->
    <update id="update" parameterType="PostVO">
        UPDATE TBL_POST
        SET POST_TITLE = #{postTitle},
        POST_CONTENT = #{postContent}
        WHERE ID = #{id}
    </update>

    <!-- 게시글 삭제 (Post) -->
    <delete id="deletePostById" parameterType="Long">
        DELETE FROM TBL_POST WHERE ID = #{postId}
    </delete>

    <delete id="deleteLikesByPostId" parameterType="Long">
        DELETE FROM TBL_POST_LIKE WHERE POST_ID = #{postId}
    </delete>

    <delete id="deletePostImages" parameterType="Long">
        DELETE FROM TBL_POST_IMAGE WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteReportsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_REPORT WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteRecentsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_RECENT WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteCommentsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT WHERE POST_ID = #{postId}
    </delete>

    <delete id="deleteRepliesByPostId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY
        WHERE POST_COMMENT_ID IN (SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = #{postId})
    </delete>

    <delete id="deleteCommentLikesByPostId" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT_LIKE
        WHERE POST_COMMENT_ID IN (SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = #{postId})
    </delete>

    <delete id="deleteReplyLikesByPostId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY_LIKE
        WHERE POST_REPLY_ID IN (
        SELECT ID FROM TBL_POST_REPLY
        WHERE POST_COMMENT_ID IN (SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = #{postId})
        )
    </delete>

    <delete id="deleteCommentReportsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT_REPORT
        WHERE POST_COMMENT_ID IN (SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = #{postId})
    </delete>

    <delete id="deleteReplyReportsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY_REPORT
        WHERE POST_REPLY_ID IN (
        SELECT TBR.ID
        FROM TBL_POST_REPLY TBR
        JOIN TBL_POST_COMMENT TBC ON TBR.POST_COMMENT_ID = TBC.ID
        WHERE TBC.POST_ID = #{postId}
        )
    </delete>

    <!-- 댓글 삭제 -->
    <delete id="deleteCommentById" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT WHERE ID = #{commentId}
    </delete>

    <delete id="deleteCommentLikesByCommentId" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT_LIKE WHERE POST_COMMENT_ID = #{commentId}
    </delete>

    <delete id="deleteCommentReportsByCommentId" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT_REPORT WHERE POST_COMMENT_ID = #{commentId}
    </delete>

    <!-- 대댓글 삭제 -->
    <delete id="deleteRepliesByCommentId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY WHERE POST_COMMENT_ID = #{commentId}
    </delete>

    <delete id="deleteReplyLikesByCommentId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY_LIKE
        WHERE POST_REPLY_ID IN (
        SELECT ID FROM TBL_POST_REPLY WHERE POST_COMMENT_ID = #{commentId}
        )
    </delete>

    <delete id="deleteReplyReportsByCommentId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY_REPORT
        WHERE POST_REPLY_ID IN (
        SELECT ID FROM TBL_POST_REPLY WHERE POST_COMMENT_ID = #{commentId}
        )
    </delete>

    <!-- 답글 단일 삭제 -->
    <delete id="deleteReplyById" parameterType="Long">
        DELETE FROM TBL_POST_REPLY WHERE ID = #{replyId}
    </delete>

    <delete id="deleteReplyLikeByReplyId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY_LIKE WHERE POST_REPLY_ID = #{replyId}
    </delete>

    <delete id="deleteReplyReportByReplyId" parameterType="Long">
        DELETE FROM TBL_POST_REPLY_REPORT WHERE POST_REPLY_ID = #{replyId}
    </delete>

    <!-- 임시저장 등록 -->
    <insert id="insertDraft" parameterType="PostDraftVO">
        INSERT INTO TBL_POST_DRAFT(ID, POST_DRAFT_TITLE, POST_DRAFT_CONTENT, POST_DRAFT_CREATE_AT, MEMBER_ID, SOM_ID)
        VALUES(SEQ_POST_DRAFT.NEXTVAL, #{postDraftTitle, jdbcType=VARCHAR}, #{postDraftContent, jdbcType=CLOB},
            DEFAULT, #{memberId, jdbcType=NUMERIC}, #{somId, jdbcType=NUMERIC})
    </insert>

    <!-- 임시저장 조회 -->
    <select id="selectDraftById" parameterType="Long" resultType="PostDraftVO">
        SELECT ID, POST_DRAFT_TITLE, POST_DRAFT_CONTENT, POST_DRAFT_CREATE_AT, MEMBER_ID, SOM_ID
        FROM TBL_POST_DRAFT
        WHERE ID = #{id}
    </select>

    <!-- 임시저장 삭제 -->
    <delete id="deleteDraftById" parameterType="long">
        DELETE FROM TBL_POST_DRAFT WHERE ID = #{id}
    </delete>

    <!-- 댓글 좋아요 -->
    <insert id="insertCommentLike" parameterType="map">
        INSERT INTO TBL_POST_COMMENT_LIKE (ID, POST_COMMENT_ID, MEMBER_ID)
        VALUES (SEQ_POST_COMMENT_LIKE.NEXTVAL, #{commentId}, #{memberId})
    </insert>

    <delete id="deleteCommentLike" parameterType="map">
        DELETE FROM TBL_POST_COMMENT_LIKE
        WHERE POST_COMMENT_ID = #{commentId}
        AND MEMBER_ID = #{memberId}
    </delete>

    <!-- 답글 좋아요 -->
    <insert id="insertReplyLike" parameterType="map">
        INSERT INTO TBL_POST_REPLY_LIKE (ID, POST_REPLY_ID, MEMBER_ID)
        VALUES (SEQ_POST_REPLY_LIKE.NEXTVAL, #{replyId}, #{memberId})
    </insert>

    <delete id="deleteReplyLike" parameterType="map">
        DELETE FROM TBL_POST_REPLY_LIKE
        WHERE POST_REPLY_ID = #{replyId}
        AND MEMBER_ID = #{memberId}
    </delete>

    <!-- 좋아요 여부 -->
    <select id="existsCommentLike" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_COMMENT_LIKE
        WHERE POST_COMMENT_ID = #{commentId}
        AND MEMBER_ID = #{memberId}
    </select>

    <select id="existsReplyLike" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_REPLY_LIKE
        WHERE POST_REPLY_ID = #{replyId}
        AND MEMBER_ID = #{memberId}
    </select>

    <!-- 조회수 증가 -->
    <update id="updateReadCount" parameterType="Long">
        UPDATE TBL_POST
        SET POST_READ_COUNT = POST_READ_COUNT + 1
        WHERE ID = #{id}
    </update>

    <!-- 최근 본 게시글 등록/갱신 -->
    <insert id="insertOrUpdateRecentView" parameterType="map">
        MERGE INTO TBL_POST_RECENT TPR
        USING(SELECT #{memberId} AS MEMBER_ID, #{postId} AS POST_ID FROM DUAL )
        SRC ON(TPR.MEMBER_ID = SRC.MEMBER_ID AND TPR.POST_ID = SRC.POST_ID )
        WHEN MATCHED THEN
        UPDATE SET TPR.POST_RECENT_CREATE_AT = SYSTIMESTAMP
        WHEN NOT MATCHED THEN
        INSERT (ID, MEMBER_ID, POST_ID)
        VALUES (SEQ_POST_RECENT.NEXTVAL, SRC.MEMBER_ID, SRC.POST_ID)
    </insert>

    <!-- 댓글 등록 -->
    <insert id="insertComment" parameterType="PostCommentVO">
        INSERT INTO TBL_POST_COMMENT (ID, POST_COMMENT_CONTENT, POST_COMMENT_CREATE_AT, POST_ID, MEMBER_ID )
        VALUES (SEQ_POST_COMMENT.NEXTVAL, #{postCommentContent}, SYSTIMESTAMP, #{postId}, #{memberId})
    </insert>

    <!-- 답글 등록 -->
    <insert id="insertReply" parameterType="PostReplyVO">
        INSERT INTO TBL_POST_REPLY (ID, POST_REPLY_CONTENT, POST_REPLY_CREATE_AT, POST_COMMENT_ID, MEMBER_ID )
        VALUES (SEQ_POST_REPLY.NEXTVAL, #{postReplyContent}, SYSTIMESTAMP, #{postCommentId}, #{memberId})
    </insert>

    <!-- 게시글 좋아요 여부 -->
    <select id="existsLike" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_LIKE
        WHERE POST_ID = #{postId}
        AND MEMBER_ID = #{memberId}
    </select>

    <!-- 게시글 좋아요 추가 -->
    <insert id="insertLike" parameterType="map">
        INSERT INTO TBL_POST_LIKE (ID, POST_ID, MEMBER_ID)
        VALUES (SEQ_POST_LIKE.NEXTVAL, #{postId}, #{memberId})
    </insert>

    <!-- 게시글 좋아요 취소 -->
    <delete id="deleteLike" parameterType="map">
        DELETE FROM TBL_POST_LIKE
        WHERE POST_ID = #{postId}
        AND MEMBER_ID = #{memberId}
    </delete>

    <!-- 게시글 상세 조회 -->
    <select id="selectPost" parameterType="map" resultType="PostDetailDTO">
        SELECT
        TBP.ID,
        TBP.POST_TITLE,
        TBP.POST_CONTENT,
        TBP.POST_CREATE_AT,
        TBP.POST_READ_COUNT,
        TBM.MEMBER_NICKNAME,
        NVL(TMP.MEMBER_PROFILE_PATH || TMP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        TBP.MEMBER_ID AS MEMBER_ID,

        (SELECT COUNT(*)
        FROM TBL_POST_LIKE TPL
        WHERE TPL.POST_ID = TBP.ID) AS POST_LIKE_COUNT,

        (SELECT COUNT(*)
        FROM TBL_POST_LIKE TPL2
        WHERE TPL2.POST_ID = TBP.ID
        AND TPL2.MEMBER_ID = #{memberId}) AS POST_IS_LIKE

        FROM TBL_POST TBP
        JOIN TBL_MEMBER TBM ON TBP.MEMBER_ID = TBM.ID
        LEFT JOIN TBL_MEMBER_PROFILE TMP ON TBM.ID = TMP.MEMBER_ID

        WHERE TBP.ID = #{postId}
    </select>

    <!-- 댓글 조회 -->
    <select id="selectComment" parameterType="map" resultType="PostCommentDTO">
        SELECT
        TBC.ID,
        TBC.POST_COMMENT_CONTENT,
        TBC.POST_COMMENT_CREATE_AT,
        TBC.POST_ID,
        TBC.MEMBER_ID,
        TBM.MEMBER_NICKNAME,

        NVL(TBMP.MEMBER_PROFILE_PATH || TBMP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,

        (SELECT COUNT(*) FROM TBL_POST_COMMENT_LIKE WHERE POST_COMMENT_ID = TBC.ID) AS POST_COMMENT_LIKE_COUNT,
        (SELECT COUNT(*) FROM TBL_POST_COMMENT_LIKE WHERE POST_COMMENT_ID = TBC.ID AND MEMBER_ID = #{memberId}) AS IS_COMMENT_LIKED

        FROM TBL_POST_COMMENT TBC
        JOIN TBL_MEMBER TBM ON TBC.MEMBER_ID = TBM.ID

        LEFT JOIN TBL_MEMBER_PROFILE TBMP ON TBM.ID = TBMP.MEMBER_ID

        WHERE TBC.POST_ID = #{postId}
        ORDER BY TBC.ID ASC

    </select>

    <!-- 답글 조회 -->
    <select id="selectReply" parameterType="map" resultType="PostReplyDTO">
        SELECT
        TPR.ID,
        TPR.POST_REPLY_CONTENT,
        TPR.POST_REPLY_CREATE_AT,
        TPR.POST_COMMENT_ID,
        TPR.MEMBER_ID,
        TBM.MEMBER_NICKNAME,

        NVL(TBMP.MEMBER_PROFILE_PATH || TBMP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,

        (SELECT COUNT(*) FROM TBL_POST_REPLY_LIKE WHERE POST_REPLY_ID = TPR.ID) AS POST_REPLY_LIKE_COUNT,
        (SELECT COUNT(*) FROM TBL_POST_REPLY_LIKE WHERE POST_REPLY_ID = TPR.ID AND MEMBER_ID = #{memberId}) AS IS_REPLY_LIKED

        FROM TBL_POST_REPLY TPR
        JOIN TBL_MEMBER TBM ON TPR.MEMBER_ID = TBM.ID

        LEFT JOIN TBL_MEMBER_PROFILE TBMP ON TBM.ID = TBMP.MEMBER_ID

        WHERE TPR.POST_COMMENT_ID = #{commentId}
        ORDER BY TPR.ID ASC
    </select>

    <!-- 게시글 신고 -->
    <insert id="insertPostReport" parameterType="PostReportVO">
        INSERT INTO TBL_POST_REPORT (ID, POST_REPORT_CONTENT, POST_REPORT_CREATE_AT, POST_ID, MEMBER_ID)
        VALUES (SEQ_POST_REPORT.NEXTVAL, #{postReportContent}, SYSTIMESTAMP, #{postId}, #{memberId})
    </insert>

    <!-- 게시글 신고 중복 체크 -->
    <select id="checkPostReportExists" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_REPORT
        WHERE POST_ID = #{postId}
        AND MEMBER_ID = #{memberId}
    </select>

    <!-- 댓글 신고 -->
    <insert id="insertPostCommentReport"
            parameterType="PostCommentReportVO">
        INSERT INTO TBL_POST_COMMENT_REPORT (
        ID,
        POST_COMMENT_REPORT_CONTENT,
        POST_COMMENT_REPORT_CREATE_AT,
        POST_COMMENT_ID,
        MEMBER_ID
        ) VALUES (
        SEQ_POST_COMMENT_REPORT.NEXTVAL,
        #{postCommentReportContent},
        SYSTIMESTAMP,
        #{postCommentId},
        #{memberId}
        )
    </insert>

    <!-- 댓글 신고 중복 -->
    <select id="checkCommentReportExists" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_COMMENT_REPORT
        WHERE POST_COMMENT_ID = #{postCommentId}
        AND MEMBER_ID = #{memberId}
    </select>

    <!-- 답글 신고 -->
    <insert id="insertPostReplyReport" parameterType="PostReplyReportVO">
        INSERT INTO TBL_POST_REPLY_REPORT (ID, POST_REPLY_REPORT_CONTENT, POST_REPLY_REPORT_CREATE_AT, POST_REPLY_ID, MEMBER_ID)
        VALUES (SEQ_POST_REPLY_REPORT.NEXTVAL, #{postReplyReportContent}, SYSTIMESTAMP, #{postReplyId}, #{memberId})
    </insert>

    <!-- 답글 신고 중복 -->
    <select id="checkReplyReportExists" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_REPLY_REPORT
        WHERE POST_REPLY_ID = #{postReplyId}
        AND MEMBER_ID = #{memberId}
    </select>

    <!-- 다음 글 -->
    <select id="selectNextPost" parameterType="Long" resultType="PostNeighborDTO">
        SELECT ID, POST_TITLE
        FROM TBL_POST
        WHERE ID > #{id}
        AND POST_STATUS = 'Y'
        ORDER BY ID ASC
        FETCH FIRST 1 ROW ONLY
    </select>

    <!-- 이전 글 -->
    <select id="selectPrevPost" parameterType="Long" resultType="PostNeighborDTO">
        SELECT ID, POST_TITLE
        FROM TBL_POST
        WHERE ID <![CDATA[<]]> #{id}
        AND POST_STATUS = 'Y'
        ORDER BY ID DESC
        FETCH FIRST 1 ROW ONLY
    </select>
</mapper>
