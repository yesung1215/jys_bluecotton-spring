<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.bluecotton.mapper.PostMapper">

    <!-- 오늘의 솜 메인페이지 게시글 리스트 조회 (+ 좋아요 여부 포함) -->
    <select id="select" parameterType="map" resultType="com.app.bluecotton.domain.dto.post.PostMainDTO">
        SELECT
        TBP.ID AS POST_ID,
        TBS.SOM_CATEGORY,
        TBS.SOM_TITLE AS SOM_TITLE,
        TRUNC(TRUNC(SYSDATE) - TRUNC(TBS.SOM_START_DATE)) + 1 AS POST_SOM_DAY,
        TBP.POST_TITLE,
        TBP.POST_CONTENT,
        TBM.MEMBER_NICKNAME,
        NVL(TBMP.MEMBER_PROFILE_PATH || TBMP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        TBP.POST_CREATE_AT,
        TBP.POST_READ_COUNT,
        NVL(TPI.POST_IMAGE_PATH || TPI.POST_IMAGE_NAME, '/upload/default/default_post.jpg') AS POST_IMAGE_URL,
        (SELECT COUNT(*) FROM TBL_POST_LIKE L WHERE L.POST_ID = TBP.ID) AS POST_LIKE_COUNT,
        (
        SELECT COUNT(*) FROM TBL_POST_COMMENT C WHERE C.POST_ID = TBP.ID
        ) +
        (
        SELECT COUNT(*) FROM TBL_POST_REPLY R
        WHERE R.POST_COMMENT_ID IN (
        SELECT ID FROM TBL_POST_COMMENT WHERE POST_ID = TBP.ID
        )
        ) AS POST_COMMENT_COUNT,
        CASE
        WHEN EXISTS (
        SELECT 1 FROM TBL_POST_LIKE L
        WHERE L.POST_ID = TBP.ID AND L.MEMBER_ID = #{memberId}
        ) THEN 1
        ELSE 0
        END AS POST_IS_LIKE
        FROM TBL_POST TBP
        JOIN TBL_MEMBER TBM ON TBP.MEMBER_ID = TBM.ID
        LEFT JOIN TBL_SOM TBS ON TBP.SOM_ID = TBS.ID
        LEFT JOIN TBL_MEMBER_PROFILE TBMP ON TBM.ID = TBMP.MEMBER_ID
        LEFT JOIN TBL_POST_IMAGE TPI ON TBP.ID = TPI.POST_ID
        WHERE 1=1
        <if test="somCategory != null and somCategory != ''">
            AND UPPER(TBS.SOM_CATEGORY) = UPPER(#{somCategory})
        </if>
        <choose>
            <when test="orderType == 'view'">
                ORDER BY TBP.POST_READ_COUNT DESC, TBP.ID DESC
            </when>
            <when test="orderType == 'popular'">
                ORDER BY POST_LIKE_COUNT DESC, TBP.ID DESC
            </when>
            <when test="orderType == 'comment'">
                ORDER BY POST_COMMENT_COUNT DESC, TBP.ID DESC
            </when>
            <otherwise>
                ORDER BY TBP.POST_CREATE_AT DESC, TBP.ID DESC
            </otherwise>
        </choose>
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="com.app.bluecotton.domain.vo.post.PostVO">
        <selectKey keyProperty="id" order="BEFORE" resultType="Long">
            SELECT SEQ_POST.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TBL_POST (
        ID, POST_TITLE, POST_CONTENT, POST_CREATE_AT,
        POST_READ_COUNT, POST_STATUS, MEMBER_ID, SOM_ID
        ) VALUES (
        #{id}, #{postTitle}, #{postContent},
        SYSTIMESTAMP, 0, 'Y', #{memberId}, #{somId}
        )
    </insert>

    <!-- 특정 회원이 오늘 특정 솜(SOM_ID)에 이미 게시했는지 확인 -->
    <select id="existsTodayPostInSom" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST
        WHERE MEMBER_ID = #{memberId}
        AND SOM_ID = #{somId}
        AND POST_STATUS = 'Y'
        AND TRUNC(POST_CREATE_AT) = TRUNC(SYSDATE)
    </select>

    <!-- 업로드된 이미지 → 게시글 ID 매핑 -->
    <update id="updatePostIdByUrl">
        UPDATE TBL_POST_IMAGE
        SET POST_ID = #{postId}
        WHERE POST_IMAGE_PATH || POST_IMAGE_NAME = #{url}
    </update>

    <!-- 기본 이미지 등록 -->
    <insert id="insertDefaultImage">
        INSERT INTO TBL_POST_IMAGE (
        ID, POST_IMAGE_PATH, POST_IMAGE_NAME, POST_ID
        ) VALUES (
        SEQ_POST_IMAGE.NEXTVAL,
        #{postImagePath}, #{postImageName}, #{postId}
        )
    </insert>

    <!-- 첫 번째 이미지를 대표 썸네일로 등록 -->
    <insert id="insertThumbnail">
        INSERT INTO TBL_POST_IMAGE (
        ID, POST_IMAGE_PATH, POST_IMAGE_NAME, POST_ID
        ) VALUES (
        SEQ_POST_IMAGE.NEXTVAL,
        #{postImagePath}, #{postImageName}, #{postId}
        )
    </insert>

    <!-- [게시글 등록용] 회원이 참여 중인 솜 목록 조회 -->
    <select id="findJoinedSomsByMemberId" parameterType="Long" resultType="com.app.bluecotton.domain.dto.post.SomCategoryDTO">
        SELECT
        S.ID AS SOM_ID,
        S.SOM_CATEGORY
        FROM TBL_SOM S
        JOIN TBL_SOM_PARTICIPANT SP ON S.ID = SP.SOM_ID
        WHERE SP.MEMBER_ID = #{memberId}
    </select>

    <!-- [게시글 수정용 단건 조회] -->
    <select id="findByIdForUpdate" parameterType="Long" resultType="com.app.bluecotton.domain.dto.post.PostModifyDTO">
        SELECT
        P.ID AS POST_ID,
        P.POST_TITLE AS POST_TITLE,
        P.POST_CONTENT AS POST_CONTENT,
        P.MEMBER_ID AS MEMBER_ID,
        P.SOM_ID AS SOM_ID,
        S.SOM_CATEGORY AS SOM_CATEGORY
        FROM TBL_POST P
        JOIN TBL_SOM S ON P.SOM_ID = S.ID
        WHERE P.ID = #{id}
    </select>

    <!-- [게시글 수정용] 회원이 참여 중인 솜 목록 조회 (수정 드롭다운용) -->
    <select id="findJoinedCategories" parameterType="Long" resultType="com.app.bluecotton.domain.dto.post.SomCategoryDTO">
        SELECT
        S.ID AS SOM_ID,
        S.SOM_CATEGORY
        FROM TBL_SOM S
        JOIN TBL_SOM_JOIN SJ ON S.ID = SJ.SOM_ID
        WHERE SJ.MEMBER_ID = #{memberId}
    </select>

    <!-- [게시글 수정 처리] -->
    <update id="update" parameterType="com.app.bluecotton.domain.vo.post.PostVO">
        UPDATE TBL_POST
        SET POST_TITLE = #{postTitle},
        POST_CONTENT = #{postContent}
        WHERE ID = #{id}
    </update>

    <!-- 게시글 자체 삭제 -->
    <delete id="deletePostById" parameterType="Long">
        DELETE FROM TBL_POST
        WHERE ID = #{id}
    </delete>

    <!-- 게시글 좋아요 삭제 -->
    <delete id="deleteLikesByPostId" parameterType="Long">
        DELETE FROM TBL_POST_LIKE
        WHERE POST_ID = #{postId}
    </delete>

    <!-- 특정 게시글의 이미지 삭제 -->
    <delete id="deletePostImages" parameterType="Long">
        DELETE FROM TBL_POST_IMAGE
        WHERE POST_ID = #{postId}
    </delete>

    <!-- 특정 게시글 관련 신고 내역 삭제 -->
    <delete id="deleteReportsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_REPORT
        WHERE POST_ID = #{postId}
    </delete>

    <!-- 특정 게시글의 최근 본 기록 삭제 -->
    <delete id="deleteRecentsByPostId" parameterType="Long">
        DELETE FROM TBL_POST_RECENT
        WHERE POST_ID = #{postId}
    </delete>

    <!-- 댓글/답글 삭제-->
    <delete id="deleteComment" parameterType="Long">
        DELETE FROM TBL_POST_COMMENT
        WHERE ID = #{id}
    </delete>

    <delete id="deleteReply" parameterType="Long">
        DELETE FROM TBL_POST_REPLY
        WHERE ID = #{id}
    </delete>

    <!-- 임시저장 등록(새 작성 창에서) -->
    <insert id="insertDraft" parameterType="com.app.bluecotton.domain.vo.post.PostDraftVO">
        INSERT INTO TBL_POST_DRAFT (
        ID,
        POST_DRAFT_TITLE,
        POST_DRAFT_CONTENT,
        POST_DRAFT_CREATE_AT,
        MEMBER_ID,
        SOM_ID
        )
        VALUES (
        SEQ_POST_DRAFT.NEXTVAL,
        #{postDraftTitle, jdbcType=VARCHAR},
        #{postDraftContent, jdbcType=VARCHAR},
        DEFAULT,
        #{memberId, jdbcType=NUMERIC},
        #{somId, jdbcType=NUMERIC}
        )
    </insert>


    <!-- 임시저장 조회 -->
    <select id="selectDraftById" parameterType="long" resultType="com.app.bluecotton.domain.vo.post.PostDraftVO">
        SELECT
        ID AS postDraftId,
        POST_DRAFT_TITLE AS postDraftTitle,
        POST_DRAFT_CONTENT AS postDraftContent,
        POST_DRAFT_CREATE_AT AS postDraftCreateAt,
        MEMBER_ID AS memberId,
        SOM_ID AS somId
        FROM TBL_POST_DRAFT
        WHERE ID = #{id}
    </select>

    <!-- 임시저장 삭제 -->
    <delete id="deleteDraftById" parameterType="long">
        DELETE FROM TBL_POST_DRAFT
        WHERE ID = #{id}
    </delete>

    <!-- 게시글 상세 조회 좋아요 여부 포함 -->
    <select id="selectPostDetailByIdWithLike" parameterType="map"
            resultType="com.app.bluecotton.domain.dto.post.PostDetailDTO">
        SELECT
        P.ID AS POST_ID,
        P.POST_TITLE,
        P.POST_CONTENT,
        NVL(PI.POST_IMAGE_PATH || PI.POST_IMAGE_NAME, '/upload/default/default_post.jpg') AS POST_IMAGE_URL,
        P.POST_CREATE_AT,
        P.POST_READ_COUNT,
        M.MEMBER_NICKNAME,
        NVL(MP.MEMBER_PROFILE_PATH || MP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        (SELECT COUNT(*) FROM TBL_POST_LIKE L WHERE L.POST_ID = P.ID) AS POST_LIKE_COUNT,
        CASE
        WHEN EXISTS (
        SELECT 1 FROM TBL_POST_LIKE L
        WHERE L.POST_ID = P.ID AND L.MEMBER_ID = #{memberId}
        ) THEN 1 ELSE 0
        END AS POST_IS_LIKE
        FROM TBL_POST P
        JOIN TBL_MEMBER M ON P.MEMBER_ID = M.ID
        LEFT JOIN TBL_MEMBER_PROFILE MP ON MP.MEMBER_ID = M.ID
        LEFT JOIN TBL_POST_IMAGE PI ON PI.POST_ID = P.ID
        WHERE P.ID = #{postId}
    </select>

    <!-- 댓글 좋아요 여부 포함 조회 -->
    <select id="selectCommentsByPostIdWithLike" parameterType="map"
            resultType="com.app.bluecotton.domain.dto.post.PostCommentDTO">
        SELECT
        C.ID AS COMMENT_ID,
        C.POST_COMMENT_CONTENT AS COMMENT_CONTENT,
        C.POST_COMMENT_CREATE_AT AS COMMENT_CREATE_AT,
        M.MEMBER_NICKNAME,
        NVL(MP.MEMBER_PROFILE_PATH || MP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        NVL(CL.LIKE_COUNT, 0) AS COMMENT_LIKE_COUNT,
        CASE
        WHEN EXISTS (
        SELECT 1
        FROM TBL_POST_COMMENT_LIKE L
        WHERE L.POST_COMMENT_ID = C.ID
        AND L.MEMBER_ID = #{memberId}
        ) THEN 1
        ELSE 0
        END AS IS_COMMENT_LIKED
        FROM TBL_POST_COMMENT C
        JOIN TBL_MEMBER M ON C.MEMBER_ID = M.ID
        LEFT JOIN TBL_MEMBER_PROFILE MP ON MP.MEMBER_ID = M.ID
        LEFT JOIN (
        SELECT POST_COMMENT_ID, COUNT(*) AS LIKE_COUNT
        FROM TBL_POST_COMMENT_LIKE
        GROUP BY POST_COMMENT_ID
        ) CL ON C.ID = CL.POST_COMMENT_ID
        WHERE C.POST_ID = #{postId}
        ORDER BY C.ID ASC
    </select>

    <!-- 대댓글 좋아요 여부 포함 조회 -->
    <select id="selectRepliesByCommentIdWithLike" parameterType="map"
            resultType="com.app.bluecotton.domain.dto.post.PostReplyDTO">
        SELECT
        R.ID AS REPLY_ID,
        R.POST_REPLY_CONTENT AS REPLY_CONTENT,
        R.POST_REPLY_CREATE_AT AS REPLY_CREATE_AT,
        M.MEMBER_NICKNAME,
        NVL(MP.MEMBER_PROFILE_PATH || MP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        NVL(RL.LIKE_COUNT, 0) AS REPLY_LIKE_COUNT,
        CASE
        WHEN EXISTS (
        SELECT 1
        FROM TBL_POST_REPLY_LIKE L
        WHERE L.POST_REPLY_ID = R.ID
        AND L.MEMBER_ID = #{memberId}
        ) THEN 1
        ELSE 0
        END AS IS_REPLY_LIKED
        FROM TBL_POST_REPLY R
        JOIN TBL_MEMBER M ON R.MEMBER_ID = M.ID
        LEFT JOIN TBL_MEMBER_PROFILE MP ON MP.MEMBER_ID = M.ID
        LEFT JOIN (
        SELECT POST_REPLY_ID, COUNT(*) AS LIKE_COUNT
        FROM TBL_POST_REPLY_LIKE
        GROUP BY POST_REPLY_ID
        ) RL ON R.ID = RL.POST_REPLY_ID
        WHERE R.POST_COMMENT_ID = #{commentId}
        ORDER BY R.ID ASC
    </select>

    <!-- 댓글 좋아요 토글 -->
    <insert id="insertCommentLike" parameterType="map">
        INSERT INTO TBL_POST_COMMENT_LIKE (ID, POST_COMMENT_ID, MEMBER_ID)
        VALUES (SEQ_POST_COMMENT_LIKE.NEXTVAL, #{commentId}, #{memberId})
    </insert>

    <delete id="deleteCommentLike" parameterType="map">
        DELETE FROM TBL_POST_COMMENT_LIKE
        WHERE POST_COMMENT_ID = #{commentId}
        AND MEMBER_ID = #{memberId}
    </delete>

    <!-- 대댓글 좋아요 토글 -->
    <insert id="insertReplyLike" parameterType="map">
        INSERT INTO TBL_POST_REPLY_LIKE (ID, POST_REPLY_ID, MEMBER_ID)
        VALUES (SEQ_POST_REPLY_LIKE.NEXTVAL, #{replyId}, #{memberId})
    </insert>

    <delete id="deleteReplyLike" parameterType="map">
        DELETE FROM TBL_POST_REPLY_LIKE
        WHERE POST_REPLY_ID = #{replyId}
        AND MEMBER_ID = #{memberId}
    </delete>

    <!-- 좋아요 눌렀는지 여부 -->
    <select id="existsCommentLike" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM TBL_POST_COMMENT_LIKE
        WHERE POST_COMMENT_ID = #{commentId} AND MEMBER_ID = #{memberId}
    </select>

    <select id="existsReplyLike" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM TBL_POST_REPLY_LIKE
        WHERE POST_REPLY_ID = #{replyId} AND MEMBER_ID = #{memberId}
    </select>

    <!-- 게시글 댓글 전체 조회 -->
    <select id="selectCommentsByPostId" parameterType="Long" resultType="com.app.bluecotton.domain.dto.post.PostCommentDTO">
        SELECT
        C.ID AS COMMENT_ID,
        C.POST_COMMENT_CONTENT AS COMMENT_CONTENT,
        C.POST_COMMENT_CREATE_AT AS COMMENT_CREATE_AT,
        M.MEMBER_NICKNAME,
        NVL(MP.MEMBER_PROFILE_PATH || MP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        NVL(CL.LIKE_COUNT, 0) AS COMMENT_LIKE_COUNT
        FROM TBL_POST_COMMENT C
        JOIN TBL_MEMBER M ON C.MEMBER_ID = M.ID
        LEFT JOIN TBL_MEMBER_PROFILE MP ON MP.MEMBER_ID = M.ID
        LEFT JOIN (
        SELECT POST_COMMENT_ID, COUNT(*) AS LIKE_COUNT
        FROM TBL_POST_COMMENT_LIKE
        GROUP BY POST_COMMENT_ID
        ) CL ON C.ID = CL.POST_COMMENT_ID
        WHERE C.POST_ID = #{postId}
        ORDER BY C.ID ASC
    </select>

    <!-- 댓글별 대댓글 전체 조회 -->
    <select id="selectRepliesByCommentId" parameterType="Long" resultType="com.app.bluecotton.domain.dto.post.PostReplyDTO">
        SELECT
        R.ID AS REPLY_ID,
        R.POST_REPLY_CONTENT AS REPLY_CONTENT,
        R.POST_REPLY_CREATE_AT AS REPLY_CREATE_AT,
        M.MEMBER_NICKNAME,
        NVL(MP.MEMBER_PROFILE_PATH || MP.MEMBER_PROFILE_NAME, '/images/default_profile.png') AS MEMBER_PROFILE_URL,
        NVL(RL.LIKE_COUNT, 0) AS REPLY_LIKE_COUNT
        FROM TBL_POST_REPLY R
        JOIN TBL_MEMBER M ON R.MEMBER_ID = M.ID
        LEFT JOIN TBL_MEMBER_PROFILE MP ON MP.MEMBER_ID = M.ID
        LEFT JOIN (
        SELECT POST_REPLY_ID, COUNT(*) AS LIKE_COUNT
        FROM TBL_POST_REPLY_LIKE
        GROUP BY POST_REPLY_ID
        ) RL ON R.ID = RL.POST_REPLY_ID
        WHERE R.POST_COMMENT_ID = #{commentId}
        ORDER BY R.ID ASC
    </select>

    <!-- 조회수 갱신 -->
    <update id="updateReadCount" parameterType="Long">
        UPDATE TBL_POST
        SET POST_READ_COUNT = POST_READ_COUNT + 1
        WHERE ID = #{id}
    </update>

    <!-- [최근 본 게시글 등록 or 갱신] -->
    <insert id="insertOrUpdateRecentView" parameterType="map">
        MERGE INTO TBL_POST_RECENT TPR
        USING (SELECT #{memberId} AS MEMBER_ID, #{postId} AS POST_ID FROM DUAL) SRC
        ON (TPR.MEMBER_ID = SRC.MEMBER_ID AND TPR.POST_ID = SRC.POST_ID)
        WHEN MATCHED THEN
        UPDATE SET TPR.POST_RECENT_CREATE_AT = SYSTIMESTAMP
        WHEN NOT MATCHED THEN
        INSERT (ID, MEMBER_ID, POST_ID)
        VALUES (SEQ_POST_RECENT.NEXTVAL, SRC.MEMBER_ID, SRC.POST_ID)
    </insert>

    <!-- 댓글 등록 -->
    <insert id="insertComment" parameterType="com.app.bluecotton.domain.vo.post.PostCommentVO">
        INSERT INTO TBL_POST_COMMENT(
        ID, POST_COMMENT_CONTENT, POST_COMMENT_CREATE_AT, POST_ID, MEMBER_ID
        )
        VALUES(
        SEQ_POST_COMMENT.NEXTVAL, #{postCommentContent}, SYSTIMESTAMP, #{postId}, #{memberId}
        )
    </insert>

    <!-- 답글 등록 -->
    <insert id="insertReply" parameterType="com.app.bluecotton.domain.vo.post.PostReplyVO">
        INSERT INTO TBL_POST_REPLY (
        ID, POST_REPLY_CONTENT, POST_REPLY_CREATE_AT, POST_COMMENT_ID, MEMBER_ID
        )
        VALUES (
        SEQ_POST_REPLY.NEXTVAL, #{postReplyContent}, SYSTIMESTAMP, #{postCommentId}, #{memberId}
        )
    </insert>

    <!-- 좋아요 여부 확인 -->
    <select id="existsLike" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM TBL_POST_LIKE
        WHERE POST_ID = #{postId}
        AND MEMBER_ID = #{memberId}
    </select>

    <!-- 좋아요 추가 -->
    <insert id="insertLike" parameterType="map">
        INSERT INTO TBL_POST_LIKE (ID, POST_ID, MEMBER_ID)
        VALUES (SEQ_POST_LIKE.NEXTVAL, #{postId}, #{memberId})
    </insert>

    <!-- 좋아요 취소 -->
    <delete id="deleteLike" parameterType="map">
        DELETE FROM TBL_POST_LIKE
        WHERE POST_ID = #{postId}
        AND MEMBER_ID = #{memberId}
    </delete>

</mapper>
